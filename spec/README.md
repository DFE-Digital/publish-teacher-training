# Using Factories

We are using
[factory_bot_rails](https://github.com/thoughtbot/factory_bot_rails#factory_bot_rails----)
to generate valid graphs of objects for testing.

This readme documents our chosen pattern for using them and creating them.

* `let(:thing)...{}` is deferred (memoized) creation, not run until the variable (`thing` in this case) is referenced
* `let!(:thing)...{}` is run immediately
* `build()` builds the object(s) in memory only
* `create()` builds the object(s) in memory and saves it to the database

## Creation

To create a course, its provider and any other objects needed to create a valid
course and save it to the database (obeying nullability and foreign key rules):

```
let(:course)  { create :course }
```

Note that the use of `let` defers creation till variable `course` is
referenced.  This is preferred over `let!` unless you need it immediately for
reasons of ordering etc.

## Finding generated related objects

To get the provider implicitly generated by the course factory:

```
let(:course)  { create :course }
let(:provider) { course.provider }
```

## Overriding the creation of a dependent object

```
let(:english_subject) { create :subject, :english }
let(:course)          { create :course, subjects: [english_subject] }
```

When creating associated data, keep in mind which object is the `belongs_to`
side. The object that has the `belongs_to` association should be the one that
associates the two objects.

```
# CORRECT
let(:provider) { create :provider }
let(:course)   { create :course, provider: provider }
# CORRECT
```

```
# WRONG
let(:course)   { create :course }
let(:provider) { create :provider, courses: [course] }
# WRONG
```

If done wrong (second) way, then two providers will be created in the DB, one as the
memoized provider and second as part of the `create :course`.

## Singletons

* Use find_or_create for objects that should be singletons (e.g. "English"
  subject)


# Creating Factories

The way we do it:

1. Created objects should be valid by default, so ensure that required
   associations are built/created.
2. Avoid building/creating associations that aren't necessary. (i.e. nullable
   foreign keys, and many-to-many relationships with join tables).
3. Provide a way to overide associated objects, for has_* relationships this
   will need to build associated objects by default, and add them to the parent
   object in an `after_create` hook.
4. Provide a way to specify exactly what associated object(s) override.
5. When creating a memoized object that is included in the creation of another
   object, use `build` to prevent secondary objects from being created.
6. Factories can be tested too.
7. Don't continue the `count` trait pattern you might find already in the code
   for creating many related objects, that turned out not to be such a great
   idea. Help eliminate them if you can.
